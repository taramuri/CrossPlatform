Vagrant.configure("2") do |config|
  ubuntu_ip = "192.168.56.10"

  config.vm.define "ubuntu" do |ubuntu|
    ubuntu.vm.box = "bento/ubuntu-22.04"
    ubuntu.vm.hostname = "ubuntu-vm"
    ubuntu.vm.network "private_network", ip: ubuntu_ip
    ubuntu.vm.network "forwarded_port", guest: 5000, host: 5000

    ubuntu.vm.provider "virtualbox" do |v|
      v.name = "Ubuntu MVC VM"
      v.memory = "3072"
      v.cpus = 2
    end

    # Synchronize local folder `lab5` with the virtual machine
    ubuntu.vm.synced_folder ".", "/home/vagrant/lab5"

    ubuntu.vm.provision "shell", inline: <<-SHELL
      # Update and install required packages
      sudo apt-get update
      sudo apt-get install -y wget nginx

      # Install .NET SDK and Runtime
      wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
      sudo dpkg -i packages-microsoft-prod.deb
      sudo apt-get update
      sudo apt-get install -y dotnet-sdk-7.0 aspnetcore-runtime-7.0

      # Configure nginx to proxy to port 5000
      cat <<'EOF' | sudo tee /etc/nginx/sites-available/default
      server {
          listen 80;
          server_name localhost;

          location / {
              proxy_pass http://127.0.0.1:5000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "keep-alive";
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }
      EOF

      # Restart nginx to apply changes
      sudo systemctl restart nginx

      # Set environment variable LAB_PATH
      echo 'export LAB_PATH=/home/vagrant/lab5/lab-files' >> ~/.bashrc
      source ~/.bashrc

      # Create directory for lab-files
      mkdir -p /home/vagrant/lab5/lab-files

      # Navigate to MVC project and build
      cd /home/vagrant/lab5
      dotnet build
      dotnet publish -c Release -o /home/vagrant/lab5/publish

      # Run the application after publishing
      nohup dotnet /home/vagrant/lab5/publish/YourMvcApp.dll > /home/vagrant/app.log 2>&1 &
    SHELL
  end
end
